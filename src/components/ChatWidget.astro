---

---

// Bot√≥n flotante y contenedor
<div class="fixed bottom-6 right-6 z-50">
  <!-- Bot√≥n flotante con animaci√≥n -->
  <button
    id="toggle-chat"
    aria-label="Abrir chat con Jason"
    class="relative flex items-center justify-center bg-advisor-teal hover:bg-advisor-teal-dark text-white rounded-full shadow-2xl w-20 h-20 transition group animate-pulse"
  >
    <!-- Avatar grande -->
    <img
      src="/jason-profile.png"
      alt="Jason"
      class="w-14 h-14 rounded-full border-4 border-white"
    />

    <!-- Indicador de online -->
    <span
      class="absolute bottom-2 right-2 w-3 h-3 bg-green-500 border-2 border-white rounded-full"
    ></span>

    <!-- Tooltip flotante -->
    <span
      class="absolute bottom-full mb-2 px-3 py-1 text-sm bg-black text-white rounded shadow-sm opacity-0 group-hover:opacity-100 transition-all duration-300"
    >
      ¬°Chatea con Jason!
    </span>
  </button>

  <!-- Widget del chat -->
  <div
    id="chat-widget"
    class="w-[370px] max-h-[85vh] bg-white border border-gray-200 rounded-xl shadow-xl mt-4 hidden flex-col overflow-hidden"
  >
    <!-- Header -->
    <div
      class="bg-advisor-teal text-white px-4 py-3 text-sm font-medium flex items-center justify-between"
    >
      <div class="flex items-center gap-3">
        <img
          src="/jason-profile.png"
          alt="Jason Castro"
          class="w-10 h-10 rounded-full border-2 border-white"
        />
        <div>
          <p class="text-base font-semibold leading-tight">Jason Castro</p>
          <p class="text-xs text-white/80">Asesor de terrenos</p>
        </div>
      </div>
      <button
        id="close-chat"
        aria-label="Cerrar"
        class="text-white text-xl leading-none hover:opacity-70"
      >
        √ó
      </button>
    </div>

    <!-- Cuerpo del chat -->
    <div
      id="messages"
      class="flex-1 overflow-y-auto p-4 space-y-3 text-sm text-gray-700 bg-gray-50"
    >
      <div class="text-gray-500 text-center italic">
        üëã Hola, soy Jason. ¬øEn qu√© puedo ayudarte hoy?
      </div>
    </div>

    <!-- Input -->
    <form
      id="chat-form"
      class="border-t border-gray-200 p-2 flex gap-2 bg-white"
    >
      <input
        id="chat-input"
        type="text"
        required
        placeholder="Escribe tu mensaje..."
        class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-advisor-teal"
      />
      <button
        type="submit"
        class="px-4 py-2 bg-advisor-teal text-white text-sm rounded-md hover:bg-advisor-teal-dark transition"
      >
        Enviar
      </button>
    </form>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const toggle = document.getElementById("toggle-chat");
    const chat = document.getElementById("chat-widget");
    const close = document.getElementById("close-chat");
    const form = document.getElementById("chat-form");
    const input = document.getElementById("chat-input");
    const messagesContainer = document.getElementById("messages");

    toggle?.addEventListener("click", () => {
      chat?.classList.toggle("hidden");
    });

    close?.addEventListener("click", () => {
      chat?.classList.add("hidden");
    });

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!input || !messagesContainer) return;
      if (!(input instanceof HTMLInputElement)) return;

      const message = input.value.trim();
      if (!message) return;

      // Bubble usuario
      const userBubble = document.createElement("div");
      userBubble.className =
        "bg-advisor-teal text-white p-2 rounded-lg self-end text-right w-fit max-w-[80%] ml-auto";
      userBubble.textContent = message;
      messagesContainer.appendChild(userBubble);
      input.value = "";

      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      // Bubble respuesta
      const botBubble = document.createElement("div");
      botBubble.className =
        "bg-white border border-gray-200 p-2 rounded-lg self-start italic w-fit max-w-[80%]";
      botBubble.textContent = "Jason est√° escribiendo...";
      messagesContainer.appendChild(botBubble);

      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: message }),
        });

        const data = await res.json();
        botBubble.textContent =
          data.result || "No se pudo generar una respuesta.";
      } catch (err) {
        botBubble.textContent = "‚ùå Ocurri√≥ un error. Intenta de nuevo.";
      }

      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });
  });
</script>
